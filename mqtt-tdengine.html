<script type="text/javascript">
    RED.nodes.registerType('mqtt-tdengine', {
        category: 'storage',
        color: '#a6bbcf',
        defaults: {
            name: {value: ""},
            mqttBroker: {type: "mqtt-broker-config", required: true},
            topic: {value: "", required: true},
            qos: {value: "0"},
            tdengineConfig: {type: "tdengine-config", required: true},
            tdTable: {value: "", required: true},
            sqlTemplate: {value: "INSERT INTO ${table} VALUES (NOW, ${temperature}, ${humidity})"},
            enableBatch: {value: false},
            batchSize: {value: 100},
            batchTimeout: {value: 5000}
        },
        inputs: 1,
        outputs: 1,
        icon: "db.png",
        label: function() {
            return this.name || "MQTT to TDengine";
        }
    });
</script>

<script type="text/html" data-template-name="mqtt-tdengine">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> 名称</label>
        <input type="text" id="node-input-name" placeholder="节点名称">
    </div>
    
    <div class="form-row">
        <label for="node-input-mqttBroker"><i class="fa fa-globe"></i> MQTT服务器</label>
        <input type="text" id="node-input-mqttBroker">
    </div>
    
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> 主题</label>
        <input type="text" id="node-input-topic" placeholder="sensor/data">
    </div>
    
    <div class="form-row">
        <label for="node-input-qos"><i class="fa fa-empire"></i> QoS</label>
        <select id="node-input-qos" style="width:125px !important">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
        </select>
    </div>
    
    <div class="form-row">
        <label for="node-input-tdengineConfig"><i class="fa fa-database"></i> TDengine配置</label>
        <input type="text" id="node-input-tdengineConfig">
    </div>
    
    <div class="form-row">
        <label for="node-input-tdTable"><i class="fa fa-table"></i> 表名</label>
        <input type="text" id="node-input-tdTable" placeholder="sensor_data">
    </div>
    
    <div class="form-row">
        <label for="node-input-sqlTemplate"><i class="fa fa-code"></i> SQL模板</label>
        <textarea id="node-input-sqlTemplate" rows="3" style="width: 70%;" placeholder="INSERT INTO ${table} VALUES (NOW, ${temperature}, ${humidity})"></textarea>
    </div>
    
    <div class="form-row">
        <label for="node-input-enableBatch"><i class="fa fa-flash"></i> 启用批量插入</label>
        <input type="checkbox" id="node-input-enableBatch" style="display: inline-block; width: auto; vertical-align: top;">
    </div>
    
    <div class="form-row" id="batch-config" style="display: none;">
        <label for="node-input-batchSize"><i class="fa fa-list"></i> 批量大小</label>
        <input type="number" id="node-input-batchSize" placeholder="100" min="1" max="1000" style="width: 100px;">
        <span style="margin-left: 10px;">条数据</span>
    </div>
    
    <div class="form-row" id="batch-timeout" style="display: none;">
        <label for="node-input-batchTimeout"><i class="fa fa-clock-o"></i> 批量超时</label>
        <input type="number" id="node-input-batchTimeout" placeholder="5000" min="1000" max="60000" style="width: 100px;">
        <span style="margin-left: 10px;">毫秒</span>
    </div>
    
    <script>
        $(document).ready(function() {
            // 批量插入选项的显示/隐藏逻辑
            $('#node-input-enableBatch').change(function() {
                if ($(this).is(':checked')) {
                    $('#batch-config').show();
                    $('#batch-timeout').show();
                } else {
                    $('#batch-config').hide();
                    $('#batch-timeout').hide();
                }
            });
            
            // 初始化时检查状态
            if ($('#node-input-enableBatch').is(':checked')) {
                $('#batch-config').show();
                $('#batch-timeout').show();
            }
        });
    </script>
</script>

<script type="text/html" data-help-name="mqtt-tdengine">
    <p>此节点订阅MQTT主题，接收消息后使用TDengine WebSocket连接器将数据写入TDengine数据库。</p>
    
    <h3>配置</h3>
    <dl class="message-properties">
        <dt>名称 <span class="property-type">字符串</span></dt>
        <dd>节点的显示名称</dd>
        
        <dt>MQTT服务器 <span class="property-type">字符串</span></dt>
        <dd>MQTT代理服务器地址，例如：mqtt://localhost:1883</dd>
        
        <dt>主题 <span class="property-type">字符串</span></dt>
        <dd>要订阅的MQTT主题</dd>
        
        <dt>QoS <span class="property-type">数字</span></dt>
        <dd>MQTT消息质量等级 (0, 1, 2)</dd>
        
        <dt>TDengine WebSocket URL <span class="property-type">字符串</span></dt>
        <dd>TDengine WebSocket连接地址，例如：ws://localhost:6041 或 wss://cloud.tdengine.com</dd>
        
        <dt>数据库 <span class="property-type">字符串</span></dt>
        <dd>TDengine数据库名称</dd>
        
        <dt>表名 <span class="property-type">字符串</span></dt>
        <dd>TDengine表名称</dd>
        
        <dt>SQL模板 <span class="property-type">字符串</span></dt>
        <dd>SQL插入语句模板，支持变量替换：${payload}, ${topic}, ${table}, ${database}</dd>
    </dl>

    <h3>输出</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>包含执行结果的对象，包括成功/失败状态和相关信息</dd>
    </dl>

    <h3>详细信息</h3>
    <p>此节点订阅指定的MQTT主题，接收到消息后根据配置的SQL模板将数据写入TDengine数据库。</p>
    <p>使用TDengine的REST API进行数据插入操作。</p>
</script>